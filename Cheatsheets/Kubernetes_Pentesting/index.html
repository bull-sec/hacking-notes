<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Pentesting Kubernetes - Hacking Notes</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Pentesting Kubernetes";
        var mkdocs_page_input_path = "Cheatsheets/Kubernetes_Pentesting.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/powershell.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Hacking Notes
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome to MkDocs</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Cheatsheets</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../101_windows/">Windows Privilege Escalation 101</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-07-09-impacket/">Impacket Toolset</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-07-10-bloodhound/">BloodHound</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-07-30-file-transfers-101/">File Transfers 101</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-07-30-pivot-101/">Pivoting & Lateral Movement</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-07-30-x-without-y/">X Without Y (Living off the Land)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-08-07-auth-bypass-headers/">Auth Bypass Headers"</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-08-10-golden-ticket/">Golden Tickets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2022-10-04-pentesting-email-servers/">Email Pentesting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2023-01-15-101_icalcs/">ICACLs 101</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Pentesting Kubernetes</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#kubernetes-outline">Kubernetes Outline</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#connecting-and-using-a-k8s-cluster">Connecting and Using a k8s Cluster</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#authentication">Authentication</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#authorization">Authorization</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#admission-control">Admission Control</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rbac-role-based-access-control">RBAC (Role Based Access Control)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tools">Tools</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#attack-methods">Attack Methods</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Powershell_Empire/">Powershell Empire</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cheatsheet_js/">Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hydra_cheat_sheet/">Hydra Cheat Sheet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../linux/">Linux 101</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../msfvenom_cheatsheet/">MSFVenom Cheatsheet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../splunk_cheat_sheet/">Splunk Cheatsheet</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Recon</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Recon/mapping/">Application Mapping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Recon/recon/">Recon and Information Gathering</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Web</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Web/web_hacking/">Web Application Hacking</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Windows</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Windows/PowerShell/">PowerShell</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Windows/windows_101/">Windows 101</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Hacking Notes</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Cheatsheets &raquo;</li>
      <li>Pentesting Kubernetes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="pentesting-kubernetes">Pentesting Kubernetes</h1>
<p>Useful Links:</p>
<ul>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions">Risky Permissions</a></li>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1">Guide: Part 1</a></li>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2">Guide: Part 2</a></li>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3">Guide: Part 3</a></li>
<li><a href="https://insinuator.net/wp-content/uploads/2019/11/201911_DSC_OpenShift_v1.0_export.pdf">OpenShift Pentesting</a></li>
</ul>
<h2 id="kubernetes-outline">Kubernetes Outline</h2>
<p>Kubernetes or k8s is a "container" orchestration platform, designed to automate deployment, scaling and management of containerized applications (Docker images and such)</p>
<p>There are two main parts to the k8s architecture:</p>
<ol>
<li>Master Node</li>
<li>Worker Node</li>
</ol>
<p>A <em>cluster</em> is made up of a Master node and N Worker nodes.</p>
<p>The job of the <em>Master</em> node is to act as a command and control (c2) server for the <em>cluster</em> and provide a control for all of the worker nodes. The Master node has many different containers running on it, but the main one of interest is the <code>kube-apiserver</code> which as it's name suggests, is the API server that k8s uses to orchestrate the <em>cluster</em>.</p>
<p>All the traffic in the <em>cluster</em> is passed through this container. It also exposes an API that allows communication using a client (kubectl or customized one)</p>
<blockquote>
<p>The kube-apiserver is the only container that communicates with the etcd, which is the database of the cluster and contains all the sensitive data (tokens, passwords, etc.)</p>
</blockquote>
<p>That bit is important for our upcoming testing as it will mostly be the goal to be able to gain access to this API so that we can do things we're not supposed to be able to do.</p>
<p><img alt="Architecture Diagram" src="kubernetes_arquitecture-1024x947.png" /></p>
<p>On the worker nodes, the primary agent is the kubelet. It receives instructions from the kube-apisever and is responsible for executing the instruction such as deploying pods, which are logical groups of one or more containers, or downloading the image for the containers.</p>
<p>There are two main "users" of a k8s <em>cluster</em>:</p>
<ul>
<li>Human users</li>
<li>Service accounts</li>
</ul>
<p>Human users are exactly that, humans that are using the system. Service accounts are accounts that are configured for a particular pod to communicate with the <code>kube-apiserver</code>.</p>
<h2 id="connecting-and-using-a-k8s-cluster">Connecting and Using a k8s Cluster</h2>
<p>There are three stages that a user or service account must go through to connect to the cluster in order to receive or carry out instructions:</p>
<ul>
<li>Authentication</li>
<li>Authorization</li>
<li>Admission Control</li>
</ul>
<p>This loop is performed whenever an account sends a request to the <code>kube_apiserver</code>, the request could be something as simple as "list all pods" or something a bit more restricted such as creating a new service account.</p>
<h3 id="authentication">Authentication</h3>
<p>This is usually done with either a certificate, a token or using Basic Authentication (i.e. username &amp; password), there are also ways that it can be configured to be used with things like LDAP, but that's just an abstraction of the authentication process.</p>
<h3 id="authorization">Authorization</h3>
<p>Once the users token, certificate, or username and password combination has been verified by the cluster k8s then checks that user or service accounts permissions to see if they are allowed to perform the requested action (i.e. download a new image)</p>
<h3 id="admission-control">Admission Control</h3>
<p>These are pieces of software that are able to acccess the content that is being requested by the users or service accounts, there are lots of these "Admission Controllers":</p>
<p><a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">k8s Docs on Admission Controllers</a></p>
<h2 id="rbac-role-based-access-control">RBAC (Role Based Access Control)</h2>
<p>The RBAC uses specific “resources” and “verbs” to grant access:</p>
<ul>
<li>Resources are the information that can be accessed (e.g., information about pods, read secrets, etc.’).</li>
<li>Verbs are how the resources can be accessed (e.g., list secrets, get pods, watch, etc.’).</li>
</ul>
<h2 id="tools">Tools</h2>
<ul>
<li><a href="https://github.com/cyberark/KubiScan">KubiScan</a></li>
<li><a href="https://github.com/cyberark/kubernetes-rbac-audit">RBAC-Audit</a></li>
</ul>
<hr />
<h2 id="attack-methods">Attack Methods</h2>
<ul>
<li><em>Listing Secrets</em></li>
</ul>
<p>An attacker that gains access to list secrets in the cluster can use the following curl commands to get all secrets in “kube-system” namespace:</p>
<pre><code class="language-bash">curl -v -H “Authorization: Bearer &lt;jwt_token&gt;” https://&lt;master_ip&gt;:&lt;port&gt;/api/v1/namespaces/kube-system/secrets/
</code></pre>
<ul>
<li><em>Access Any Resource or Verb</em></li>
</ul>
<p>If you have access to see the RBAC config file then you can check to see the privileges for the cluster:</p>
<ul>
<li>Access Any Resource</li>
<li>Pod Creation</li>
<li>Create/Update Deployment, Daemonsets, Statefulsets, Replicationcontrollers, Replicasets, Jobs and Cronjobs</li>
<li>Privilege to Use Pods/Exec</li>
<li>Privilege to Get/Patch Rolebindings</li>
<li>Impersonating a Privileged Account</li>
</ul>
<blockquote>
<p>We're now looking at the TypeScript to see if we can find an XSS because the application is using websockets to speak back to the pods, so if we can find an XSS then we can send a proper request to the pods and potentially get RCE or information leakage</p>
</blockquote>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../2023-01-15-101_icalcs/" class="btn btn-neutral float-left" title="ICACLs 101"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../Powershell_Empire/" class="btn btn-neutral float-right" title="Powershell Empire">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../2023-01-15-101_icalcs/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../Powershell_Empire/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
